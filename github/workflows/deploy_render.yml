name: Deploy Opsly API to Render

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    name: Build and Deploy to Render
    runs-on: ubuntu-latest

    steps:
    - name: Generate release and changelog
      uses: google-github-actions/release-please-action@v4
        with:
          release-type: simple
          changelog-types: '[{"type":"feat","section":"ğŸš€ Features"},{"type":"fix","section":"ğŸ Fixes"},{"type":"chore","section":"ğŸ§° Maintenance"},{"type":"docs","section":"ğŸ“˜ Docs"}]'
          package-name: opsly-api
          bump-minor-pre-major: true
          bump-patch-for-minor-pre-major: true

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -f deployment/Dockerfile -t opsly-api .

    - name: Deploy to Render
      uses: johnbeynon/render-deploy-action@v1
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}